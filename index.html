<!DOCTYPE html>
<html>
  <head>
    <style type="text/css">
      html, body, #map-canvas { height: 90%; margin: 0; padding: 0;}
    </style>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<script type="text/javascript" charset="utf-8" src="cordova.js"></script>	
	<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAJOYSlyAJa_8gpiEwUbNsEsHrMP2QHrqM"></script>
	<script type="text/javascript" src="js/json2.js"></script>

	<script type="text/javascript" charset="utf-8">
		$(function(){
			document.addEventListener("deviceready", onDeviceReady, false);
		});
		
		var watchID = null;
		var map = null;
		var marker = null;
		var position = [43, -89];
		var tracking_data = []; // Array containing GPS position objects
		
		var coordinates = [];
		
		// device APIs are available
		//
		function onDeviceReady() {

			var mapOptions = {
				center: new google.maps.LatLng(position[0], position[1]),
				zoom: 16,
				disableDefaultUI: true,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			};
			
			map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
			
			if(!marker)
			{
				navigator.geolocation.getCurrentPosition(initializeMarker);
				var options = { enableHighAccuracy: true, maximumAge:3000, timeout: 5000 };
				watchID = navigator.geolocation.watchPosition(onSuccess, onError, options);
			}
		}

		function initializeMarker(position)
		{
			marker = new google.maps.Marker(
			{
				position: {lat: position.coords.latitude , lng: position.coords.longitude}, 
				optimized: false, 
				map: map
			}); 
			
			map.setCenter({lat: position.coords.latitude, lng: position.coords.longitude});
		}
		// onSuccess Geolocation
		//
		function onSuccess(position) {

			tracking_data.push(position);
			
			var result = [position.coords.latitude, position.coords.longitude];
			
			//transition(result);
			changePosition(position.coords.latitude, position.coords.longitude);
		}

		
		// onError Callback receives a PositionError object
		//
		function onError(error) {
			var element = document.getElementById('error');
			element.innerHTML = 'code: '    + error.code    + '<br />' +
								'message: ' + error.message + '<br />' +
								'<hr />'      + element.innerHTML;
		}
		
		function changePosition(latitude,longitude)
		{
			if(!marker)
			{
				marker = new google.maps.Marker(
				{
					position: {lat: latitude , lng: longitude}, 
					optimized: false, 
					map: map
				}); 
				
				map.setCenter({lat: latitude, lng: longitude});
				
			}
			else
			{
				marker.setPosition({ lat: latitude , lng: longitude });
			}
			
			var element = document.getElementById('geolocation');
			
			element.innerHTML = 'Latitude: '  + latitude      + '<br />' +
								'Longitude: ' + longitude     + '<br />' +
								'<hr />'      + element.innerHTML;		
		}
		//google.maps.event.addDomListener(window, 'load', onDeviceReady);
    </script>

      

  </head>
  <body>
	<div id="map-canvas"></div>
	<input type="button" id="btnStart" value="Start tracking"/>
	<input type="button" id="btnStop" value="Stop run"/>
	<div style="float:left;width:50%">
		<h2>Position changed</h2>
		<p id="geolocation"></p>
	</div>
	<div style="float:left;width:50%">
		<h2>Location error</h2>
		<p id="error"></p>
	</div>	

  </body>
  
  <script>
	// A $( document ).ready() block.
	$( document ).ready(function() {
		
		$("#btnStart").click(
			function(){ 

			google.maps.event.addListener(marker, "position_changed", function() {
				  var position = marker.getPosition();
				  coordinates.push(position);
				  
				  var runPath = new google.maps.Polyline({
					path: coordinates,
					geodesic: true,
					strokeColor: '#FF0000',
					strokeOpacity: 1.0,
					strokeWeight: 2
				  });

				  runPath.setMap(map);					  
			});			
			/*
			var x;
			$.ajax({
				type: "GET",
				url: "simulate.gpx",
				dataType: "xml",
				success: function(xml) {
				
					var time = 100;

					$(xml).find('trkpt').each(function(){	
						x++;
						var attributes = this.attributes;
						
						setTimeout( function(){
							changePosition(parseFloat(attributes.lat.value), parseFloat(attributes.lon.value));
						}, time)
						time += 100;
					});
				}
			});
			*/
		});
	});
  </script>
</html>