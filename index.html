<!DOCTYPE html>
<html>
  <head>
    <style type="text/css">
      html, body, #map-canvas { height: 90%; margin: 0; padding: 0;}
    </style>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<script type="text/javascript" charset="utf-8" src="cordova.js"></script>	
	<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAJOYSlyAJa_8gpiEwUbNsEsHrMP2QHrqM"></script>


	<script type="text/javascript" charset="utf-8">

		// Wait for device API libraries to load
		//
		document.addEventListener("deviceready", onDeviceReady, false);

		var watchID = null;
		var map = null;
		var marker = null;
		var position = [43, -89];
		
		// device APIs are available
		//
		function onDeviceReady() {
			// Throw an error if no update is received every 30 seconds
			var options = { enableHighAccuracy: true, maximumAge:3000, timeout: 5000 };
			watchID = navigator.geolocation.watchPosition(onSuccess, onError, options);
			
			var mapOptions = {
				center: new google.maps.LatLng(position[0], position[1]),
				zoom: 16,
				disableDefaultUI: true,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			};
			
			map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
		}

		// onSuccess Geolocation
		//
		function onSuccess(position) {
			var result = [position.coords.latitude, position.coords.longitude];
			transition(result);
			//changePosition(position.coords.latitude, position.coords.longitude);
		}

		
		// onError Callback receives a PositionError object
		//
		function onError(error) {
			var element = document.getElementById('error');
			element.innerHTML = 'code: '    + error.code    + '<br />' +
								'message: ' + error.message + '<br />' +
								'<hr />'      + element.innerHTML;
		}
		
		var numDeltas = 100;
		var delay = 10; //milliseconds
		var i = 0;
		var deltaLat;
		var deltaLng;
		
		function transition(result){
		
		
			var element = document.getElementById('geolocation');
					
			element.innerHTML = 'Latitude: '  + result[0]      + '<br />' +
						'Longitude: ' + result[1]     + '<br />' +
						'<hr />'      + element.innerHTML;	
					
			i = 0;
			deltaLat = (result[0] - position[0])/numDeltas;
			deltaLng = (result[1] - position[1])/numDeltas;
			moveMarker();
		}

		function moveMarker(){
			position[0] += deltaLat;
			position[1] += deltaLng;
			var latlng = new google.maps.LatLng(position[0], position[1]);
			
			if(!marker)
			{
				marker = new google.maps.Marker(
				{
					position: latlng, 
					optimized: false, 
					map: map//,
					//icon: "assets/img/animated-dot.gif"
				}); 
				
				map.setCenter(latlng);
			
			}
			marker.setPosition(latlng);
			if(i!=numDeltas){
				i++;
				setTimeout(moveMarker, delay);
			}			
		}
		
		google.maps.event.addDomListener(window, 'load', onDeviceReady);	
    </script>

      

  </head>
  <body>
	<div id="map-canvas"></div>
	<input type="button" id="btnStart" value="Start run"/>
	<div style="float:left;width:50%">
		<h2>Position changed</h2>
		<p id="geolocation"></p>
	</div>
	<div style="float:left;width:50%">
		<h2>Location error</h2>
		<p id="error"></p>
	</div>	

  </body>
  
  <script>
	// A $( document ).ready() block.
	$( document ).ready(function() {
		$("#btnStart").click(
			function(){  
			var x;
			$.ajax({
				type: "GET",
				url: "simulate.gpx",
				dataType: "xml",
				success: function(xml) {
				
					var time = 100;

					$(xml).find('trkpt').each(function(){	
						x++;
						var attributes = this.attributes;
						
						setTimeout( function(){
							var result = [parseFloat(attributes.lat.value), parseFloat(attributes.lon.value)];
							transition(result);
						}, time)
						time += 100;
					});
				}
			});
		});
	});
  </script>
</html>